<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 Robot Car</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#111;
  color:#fff;
}

/* ===== LANDSCAPE ONLY ===== */
#rotateNotice{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  color:#fff;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:20px;
  z-index:999;
}
#app{ display:block; }

@media (orientation: portrait){
  #app{ display:none; }
  #rotateNotice{ display:flex; }
}

/* ===== NAVBAR ===== */
.navbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  background:#1e1e1e;
}
.nav-group{ display:flex; gap:10px; }

.nav-btn{
  padding:12px 16px;
  border:none;
  border-radius:8px;
  background:#444;
  color:#fff;
  font-size:14px;
}

.nav-btn.on{
  background:#f1c40f;
  color:#000;
}

/* ===== BLINKING YELLOW ===== */
@keyframes blinkYellow {
  0%   { background:#f1c40f; color:#000; }
  50%  { background:#444; color:#fff; }
  100% { background:#f1c40f; color:#000; }
}
.nav-btn.blink{
  animation: blinkYellow 1s infinite;
}

/* ===== BUTTONS ===== */
.btn{
  padding:16px 22px;
  margin:8px;
  border:none;
  border-radius:10px;
  background:#444;
  color:#fff;
  font-size:18px;
}

.btn.move:active{
  background:#2ecc71;
  color:#000;
}

.btn.green{ background:#2ecc71; color:#000; }
.btn.red{ background:#e74c3c; color:#fff; }

/* ===== MANUAL DISABLED (NEW) ===== */
.btn.manual-disabled{
  background:#222;
  color:#777;
  pointer-events:none;
  opacity:0.6;
}

/* ===== MIC ANIMATION ===== */
@keyframes micPulse {
  0% { box-shadow:0 0 0 0 rgba(46,204,113,0.7); }
  70%{ box-shadow:0 0 0 20px rgba(46,204,113,0); }
  100%{ box-shadow:0 0 0 0 rgba(46,204,113,0); }
}
.btn.mic-listening{
  background:#2ecc71;
  color:#000;
  animation: micPulse 1.5s infinite;
}

/* ===== MODE SELECT ===== */
.container{
  padding:12px;
  text-align:center;
}
.select-box{
  width:70%;
  max-width:320px;
  padding:12px;
  font-size:16px;
  border-radius:8px;
  border:none;
  background:#444;
  color:#fff;
}

/* ===== PANELS ===== */
.panel{ display:none; padding:10px; text-align:center; }

/* ===== MANUAL MODE ===== */
.manual-wrapper{
  display:flex;
  height:calc(100vh - 140px);
}
.manual-left,
.manual-right{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
.manual-left{
  flex-direction:column;
  justify-content:space-between;
  padding:30px 0;
}
.manual-left .btn,
.manual-right .btn{ width:160px; }
.manual-right{ gap:30px; }
</style>
</head>

<body>

<div id="rotateNotice">
  <div>ðŸ”„ Rotate your phone<br>Landscape mode required</div>
</div>

<div id="app">

<!-- ===== NAVBAR ===== -->
<div class="navbar">
  <div class="nav-group">
    <button id="leftIndBtn" class="nav-btn" onclick="toggleLeftInd()">LEFT IND</button>
  </div>

  <div class="nav-group">
    <button id="headBtn" class="nav-btn" onclick="toggleHead()">HEADLIGHT</button>
    <button id="hazBtn" class="nav-btn" onclick="toggleHaz()">HAZARD</button>
  </div>

  <div class="nav-group">
    <button id="rightIndBtn" class="nav-btn" onclick="toggleRightInd()">RIGHT IND</button>
  </div>
</div>

<!-- ===== MODE SELECT ===== -->
<div class="container">
  <div class="mode-title">SELECT MODE</div>
  <select id="modeSelect" class="select-box" onchange="changeMode(this.value)">
    <option value="manual">Manual Mode</option>
    <option value="auto">Automatic Mode</option>
    <option value="follow">Follow Mode</option>
    <option value="voice">Voice Mode</option>
  </select>
</div>

<!-- ===== MANUAL MODE ===== -->
<div id="manualPanel" class="panel">
  <div class="manual-wrapper">
    <div class="manual-left">
      <button class="btn move manual-btn" onmousedown="move('f')" ontouchstart="move('f')">FORWARD</button>
      <button id="stopBtn" class="btn manual-btn" onclick="stopCar()">STOP</button>
      <button class="btn move manual-btn" onmousedown="move('b')" ontouchstart="move('b')">BACKWARD</button>
    </div>
    <div class="manual-right">
      <button class="btn move manual-btn" onmousedown="move('l')" ontouchstart="move('l')">LEFT</button>
      <button class="btn move manual-btn" onmousedown="move('r')" ontouchstart="move('r')">RIGHT</button>
    </div>
  </div>
</div>

<!-- ===== AUTOMATIC MODE ===== -->
<div id="autoPanel" class="panel">
  <button id="autoOnBtn" class="btn" onclick="setAuto(true)">ON</button>
  <button id="autoOffBtn" class="btn red" onclick="setAuto(false)">OFF</button>
</div>

<!-- ===== FOLLOW MODE ===== -->
<div id="followPanel" class="panel">
  <button id="followOnBtn" class="btn" onclick="setFollow(true)">ON</button>
  <button id="followOffBtn" class="btn red" onclick="setFollow(false)">OFF</button>
</div>

<!-- ===== VOICE MODE ===== -->
<div id="voicePanel" class="panel">
  <button id="voiceOnBtn" class="btn" onclick="setVoice(true)">ON</button>
  <button id="voiceOffBtn" class="btn red" onclick="setVoice(false)">OFF</button>
  <br><br>
  <button id="micBtn" class="btn" onclick="startMic()">TAP TO SPEAK</button>
</div>

</div>

<script>
function cmd(d,s){ fetch(`/cmd?dir=${d}&state=${s}`); }

/* ===== MODE SWITCH ===== */
function hideAll(){
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
}
function changeMode(m){
  hideAll();
  if(m==="manual") manualPanel.style.display="block";
  if(m==="auto") autoPanel.style.display="block";
  if(m==="follow") followPanel.style.display="block";
  if(m==="voice") voicePanel.style.display="block";
}

/* ===== MANUAL ===== */
function stopCar(){
  stopBtn.classList.add("red");
  cmd('s',1);
}
function move(d){
  stopBtn.classList.remove("red");
  cmd(d,1);
  setTimeout(()=>cmd(d,0),200);
}

/* ===== INDICATORS ===== */
let leftOn=false, rightOn=false, hazOn=false, headOn=false;

function toggleHead(){
  headOn=!headOn;
  headBtn.classList.toggle("on",headOn);
  fetch(`/head?on=${headOn?1:0}`);
}
function toggleLeftInd(){
  leftOn=!leftOn; hazOn=false;
  hazBtn.classList.remove("on");
  leftIndBtn.classList.toggle("blink",leftOn);
  rightIndBtn.classList.remove("blink");
  fetch(`/ind?side=L&on=${leftOn?1:0}`);
}
function toggleRightInd(){
  rightOn=!rightOn; hazOn=false;
  hazBtn.classList.remove("on");
  rightIndBtn.classList.toggle("blink",rightOn);
  leftIndBtn.classList.remove("blink");
  fetch(`/ind?side=R&on=${rightOn?1:0}`);
}
function toggleHaz(){
  hazOn=!hazOn;
  hazBtn.classList.toggle("on",hazOn);
  leftIndBtn.classList.toggle("blink",hazOn);
  rightIndBtn.classList.toggle("blink",hazOn);
  fetch(`/haz?on=${hazOn?1:0}`);
}

/* ===== MODE STATES ===== */
let autoOn=false, followOn=false, voiceOn=false;

/* ===== MANUAL ENABLE / DISABLE (NEW) ===== */
function updateManualState(){
  const disable = autoOn || followOn || voiceOn;
  document.querySelectorAll('.manual-btn').forEach(btn=>{
    btn.classList.toggle('manual-disabled', disable);
  });
}

/* ===== DROPDOWN BACKGROUND ===== */
function updateModeDropdown(){
  const o=modeSelect.options;
  for(let i=0;i<o.length;i++) o[i].style.background="";
  if(autoOn) o[1].style.background="#2ecc71";
  else if(followOn) o[2].style.background="#2ecc71";
  else if(voiceOn) o[3].style.background="#2ecc71";
  else o[0].style.background="#2ecc71";
}

/* ===== AUTO ===== */
function setAuto(v){
  autoOn=v; followOn=voiceOn=false;
  autoOnBtn.className=v?"btn green":"btn";
  autoOffBtn.className=v?"btn":"btn red";
  followOnBtn.className="btn"; followOffBtn.className="btn red";
  voiceOnBtn.className="btn"; voiceOffBtn.className="btn red";
  fetch(`/mode?auto=${v?1:0}`);
  updateModeDropdown();
  updateManualState();   // âœ… added
}

/* ===== FOLLOW ===== */
function setFollow(v){
  followOn=v; autoOn=voiceOn=false;
  followOnBtn.className=v?"btn green":"btn";
  followOffBtn.className=v?"btn":"btn red";
  autoOnBtn.className="btn"; autoOffBtn.className="btn red";
  voiceOnBtn.className="btn"; voiceOffBtn.className="btn red";
  fetch(`/follow?f=${v?1:0}`);
  updateModeDropdown();
  updateManualState();   // âœ… added
}

/* ===== VOICE ===== */
function setVoice(v){
  voiceOn=v; autoOn=followOn=false;
  voiceOnBtn.className=v?"btn green":"btn";
  voiceOffBtn.className=v?"btn":"btn red";
  autoOnBtn.className="btn"; autoOffBtn.className="btn red";
  followOnBtn.className="btn"; followOffBtn.className="btn red";
  fetch(`/voiceMode?on=${v?1:0}`);
  updateModeDropdown();
  updateManualState();   // âœ… added
}

/* ===== MIC ===== */
function startMic(){
  if(!voiceOn) return alert("Voice Mode is OFF");
  micBtn.classList.add("mic-listening");
  micBtn.textContent="LISTENING...";
  setTimeout(()=>{
    micBtn.classList.remove("mic-listening");
    micBtn.textContent="TAP TO SPEAK";
  },3000);
}

/* ===== INIT ===== */
updateModeDropdown();
updateManualState();
manualPanel.style.display="block";
</script>

</body>
</html>